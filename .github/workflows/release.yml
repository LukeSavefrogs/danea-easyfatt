name: Create Release

on:
  workflow_dispatch:
  push:
    tags:
    - 'v[0-9]+.[0-9]+.[0-9]+**'


permissions:
  contents: write

jobs:
  tests:
    uses: ./.github/workflows/run-tests.yml  # use the callable tests job to run tests

  release:
    needs: [tests]  # require tests to pass before deploy runs
    runs-on: windows-latest
    if: startsWith(github.event.ref, 'refs/tags/v')
    
    steps:
      - name: "🛒 Checkout repository"
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4
        with:
          fetch-depth: 0
      
      - name: "🐍 Install Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: "📜 Install Poetry"
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: 1.3.2

      - name: "🔍 Install dependencies"
        run: poetry install

      - name: "🎉 Generate artifacts"
        run: |
          poetry run build

      - name: "🧬 Generate Changelog"
        uses: ardalanamini/auto-changelog@v3
        id: changelog
        with:
          commit-types: |
            breaking: ⚠ Breaking Changes ⚠
            feat: ✨ Features ✨
            ✨ feat: ✨ Features ✨
            fix: 🐛 Risoluzione bug 🐛
            🐞 fix: 🐛 Risoluzione bug 🐛
            perf: 🚀 Performance 🚀
            🚀 perf: 🚀 Performance 🚀
            docs: 📄 Documentazione 📄
            📄 docs: 📄 Documentazione 📄
            other: Altre modifiche
          default-commit-type: Altre modifiche
          mention-authors: false
          mention-new-contributors: true
          include-compare: true
          semver: false

      - name: "🏁 Create Release"
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: false
          body: |
            Di seguito l'elenco delle modifiche introdotte in questa versione.
            
            ${{ steps.changelog.outputs.changelog }}
          # generateReleaseNotes: true
          makeLatest: true
          prerelease: false
          artifacts: "dist/*.exe"